# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

----------------

# Acceso a bases de datos desde lenguajes de «script» de servidor
- Integración de los lenguajes de «script» de servidor con los sistemas gestores de bases de datos.
- Conexión a bases de datos. Acceso mediante funciones nativas. Acceso mediante ODBC (Open DataBase Connectivity).
- Creación de bases de datos y tablas.
- Creación de vistas. Creación de procedimientos almacenados.
- Recuperación de la información de la base de datos desde una página web.
- Modificación de la información almacenada: inserciones, actualizaciones y borrados.
- Verificación de la información.
- Gestión de errores.
- Verificación del funcionamiento y pruebas de rendimiento.
- Mecanismos de seguridad y control de accesos.
- Documentación. 

----------------
----------------

# Repaso cliente

## Modelo de objetos del documento DOM en el servidor (PHP)
### Listar nodos de DOM
```PHP
<?php
// try this html listing example for all nodes / includes a few getElementsByTagName options:
	
	$url = "https://www.jesusninoc.com";
	$input = @file_get_contents($url) or die("Could not access file: $url");

	$dom = new DOMDocument();
	$acentos = utf8_decode($input);
	@$dom->loadHTML($acentos);

	// example 1:
	//$elements = $doc->getElementsByTagName('*');
	// example 2:
	//$elements = $doc->getElementsByTagName('html');
	// example 3:
	//$elements = $doc->getElementsByTagName('body');
	// example 4:
	//$elements = $doc->getElementsByTagName('table');
	// example 5:
	$elements = $dom->getElementsByTagName('div');

	if (!is_null($elements)) {
		foreach ($elements as $element) {
			echo "<br/>". $element->nodeName. ": ";
			$nodes = $element->childNodes;
			foreach ($nodes as $node) {
				echo $node->nodeValue. "\n";
			}
		}
	}
?>
```

### Ejemplo
#### Obtener los títulos de una web
```PHP
<?php
	$url = "https://www.jesusninoc.com";
	$input = @file_get_contents($url) or die("Could not access file: $url");

	$dom = new DOMDocument();
	$acentos = utf8_decode($input);
	@$dom->loadHTML($acentos);

  	$xpath = new DOMXpath($dom);
  	$articles = $xpath->query('//h3[@class="entry-title"]');

	foreach ($articles as $product)
	{
		echo $product->nodeValue . "</br>";
	}
?>
```

----------------

# Repaso de proyectos

- Todos
   - https://github.com/jesusninoc/ClasesIAW/blob/master/2020-01-01.md
- Proyecto convertir videoclip
  - https://www.jesusninoc.com/04/27/descargar-videos-de-youtube/
  - https://www.jesusninoc.com/01/19/extraer-datos-de-varias-imagenes-de-un-video-mp4-mediante-el-reconocimiento-optico-de-caracteres-y-el-analisis-de-imagenes-con-tensorflow/
  - https://jesusninoc.com/videoclips/
  - https://jesusninoc.com/videoclips/billy-joel-piano-man/
  - https://www.relevanssi.com/
- Proyecto compra automática en Amazon
  - https://www.jesusninoc.com/02/24/detectar-con-powershell-si-una-camara-emite-en-negro/
  - https://www.jesusninoc.com/03/06/detectar-el-color-de-un-pixel-en-powershell/
  - https://www.jesusninoc.com/01/25/detectar-si-una-imagen-esta-contenida-dentro-de-otra-imagen-mediante-opencv/
- Proyecto IBEX
  - https://www.jesusninoc.com/03/13/obtener-empresas-del-ibex-35-en-formato-json/

----------------

# Repaso de validación de formularios
* https://www.arkaitzgarro.com/javascript/capitulo-16.html#validacion

## Ejercicio: verificar que se manda un nombre y una edad en un formulario GET
### Código completo (HTML)
```HTML
<!DOCTYPE html>
<html>
<body>

<p>When you submit the form, a function is triggered which alerts some text.</p>

<form action="exampleget.php" method="get" onsubmit="myFunction()">
    Nombre: <input type="text" id="name" name="nombre" /><br />
    Edad: <input type="text" name="edad" /><br />
    <input type="submit" name="submit" value="Enviar" />
</form>

<script>
function myFunction() {
	valor = document.getElementById("name").value;
	if( valor == null || valor.length == 0 || /^\s+$/.test(valor) ) {
		alert(valor);
	  return false;
	}
}
</script>

</body>
</html>
```
### Código completo (PHP)
* https://github.com/jesusninoc/Seguridad/tree/master/GetPost

## Ayuda
#### onsubmit
* https://www.w3schools.com/jsref/event_onsubmit.asp
##### Código del onsubmit
```HTML
<!DOCTYPE html>
<html>
<body>

<p>When you submit the form, a function is triggered which alerts some text.</p>

<form action="/action_page.php" onsubmit="myFunction()">
  Enter name: <input type="text" name="fname">
  <input type="submit" value="Submit">
</form>

<script>
function myFunction() {
  alert("The form was submitted");
}
</script>

</body>
</html>
```
#### Formulario GET
* https://github.com/jesusninoc/Seguridad/blob/master/GetPost/getindex.php
#### Modificar el PHP para comprobar que se manda un nombre y una edad
* https://github.com/jesusninoc/Seguridad/blob/master/GetPost/exampleget.php

# Introducción de comportamientos dinámicos. Captura de eventos
* https://www.arkaitzgarro.com/javascript/capitulo-15.html

## Manejadores
- Manejadores como atributos de los elementos XHTML.
```HTML
<input type="button" value="Pinchame y verás" onclick="console.log('Gracias por pinchar');" />
```
- Manejadores y variable this
	- Sin this
	```HTML
	<div id="contenidos" style="width:150px; height:60px; border:thin solid silver" onmouseover="document.getElementById('contenidos').style.borderColor='black';" onmouseout="document.getElementById('contenidos').style.borderColor='silver';">
    Sección de contenidos...
	</div>
	```
	- Con this
	```HTML
	<div id="contenidos" style="width:150px; height:60px; border:thin solid silver" onmouseover="this.style.borderColor='black';" onmouseout="this.style.borderColor='silver';">
    Sección de contenidos...
	</div>		
	
- Manejadores como funciones JavaScript externas.
```JavaScript
function muestraMensaje() {
  console.log('Gracias por pinchar');
}
```
```HTML
<input type="button" value="Pinchame y verás" onclick="muestraMensaje()" />
```
- Manejadores "semánticos".
```JavaScript
function muestraMensaje() {
  console.log('Gracias por pinchar');
}
document.getElementById("pinchable").onclick = muestraMensaje;
```
```HTML
<input id="pinchable" type="button" value="Pinchame y verás" />
```

----------------
----------------

# Ejemplos PHP
## Insertar mediante GET
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
	
		$nombre = htmlspecialchars($_GET['nombre']); 
		
		$var = "../../datos.ini";
		$base = parse_ini_file($var);		
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		
		$con = $php->prepare("INSERT INTO encabezados VALUES (2,:tex);");
		$con->bindParam(':tex',$nombre);
		$con->execute();

		//$resultado = $registros[0][1];
	?>
	<h1><?php echo "buen trabajo" ?></h1>
</body>

</html>
```

## Insertar mediante GET (autoincrementando)
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
	
		$nombre = htmlspecialchars($_GET['nombre']); 
		
		$var = "../../datos.ini";
		$base = parse_ini_file($var);		
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		
		$con = $php->prepare("INSERT INTO encabezados VALUES (DEFAULT,:tex);");
		$con->bindParam(':tex',$nombre);
		$con->execute();

		//$resultado = $registros[0][1];
	?>
	<h1><?php echo "buen trabajo" ?></h1>
</body>

</html>
```

## Insertar mediante GET (autoincrementando) o mostrar un registro de una tabla
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
	
	// http://localhost/P001/default.php?enviar=almacenar&nombre=juan3dd
	
		$enviar = "";
		$resultado = "";
				
		$nombre = htmlspecialchars($_GET['nombre']); 
		$enviar = htmlspecialchars($_GET['enviar']); 
		
		$var = "../../datos.ini";
		$base = parse_ini_file($var);		
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		
		if($enviar == "almacenar")
		{
			$con = $php->prepare("INSERT INTO encabezados VALUES (DEFAULT,:tex);");
			$con->bindParam(':tex',$nombre);
			$con->execute();
			?><h1><?php echo "" ?></h1><?php
		}
		else
		{
			$con = $php->prepare("SELECT * from encabezados;");
			$con->execute();
			$registros = $con->fetchAll(PDO::FETCH_NUM);	
			$resultado = $registros[0][1];			
			?><h1><?php echo "$resultado" ?></h1><?php
		}
	?>
</body>

</html>
```

## Insertar mediante GET (autoincrementando) o mostrar un registro de una tabla de forma aleatoria
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
	
	// http://localhost/P001/default.php?enviar=almacenar&nombre=juan3dd
	
		$enviar = "";
		$resultado = "";
				
		$nombre = htmlspecialchars($_GET['nombre']); 
		$enviar = htmlspecialchars($_GET['enviar']); 
		
		$var = "../../datos.ini";
		$base = parse_ini_file($var);		
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		
		if($enviar == "almacenar")
		{
			$con = $php->prepare("INSERT INTO encabezados VALUES (DEFAULT,:tex);");
			$con->bindParam(':tex',$nombre);
			$con->execute();
			?><h1><?php echo "" ?></h1><?php
		}
		else
		{
			$con = $php->prepare("SELECT * from encabezados;");
			$con->execute();
			$registros = $con->fetchAll(PDO::FETCH_NUM);	
			$n = count($registros);
			$numero = mt_rand(0,($n-1));
			$resultado = $registros[$numero][1];			
			?><h1><?php echo "$resultado" ?></h1><?php
		}
	?>
</body>

</html>
```

## Crear un disparador que controla si se han insertado registros mediante GET y mostrar los valores insertados en el disparador
### Disparador
```MySQL
CREATE TRIGGER `secreto` BEFORE INSERT ON `encabezados`
 FOR EACH ROW BEGIN
    INSERT INTO test2 VALUES (6999999999);
END
```
### PHP
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
	
	// http://localhost/P001/default.php?enviar=almacenar&nombre=juan3dd
	
		$enviar = "";
		$resultado = "";
				
		$nombre = htmlspecialchars($_GET['nombre']); 
		$enviar = htmlspecialchars($_GET['enviar']); 
		
		$var = "../../datos.ini";
		$base = parse_ini_file($var);		
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		
		if($enviar == "almacenar")
		{
			$con = $php->prepare("INSERT INTO encabezados VALUES (DEFAULT,:tex);");
			$con->bindParam(':tex',$nombre);
			$con->execute();
			?><h1><?php echo "" ?></h1><?php
		}
		elseif($enviar == "secreto")
		{
			$con = $php->prepare("SELECT * from test2;");
			$con->execute();
			$registros = $con->fetchAll(PDO::FETCH_NUM);	
			$n = count($registros);
			$numeros = $n-1;
			$resultado = $registros[$numeros][0];			
			?><h1><?php echo "$resultado" ?></h1><?php			
		}
		else
		{
			$con = $php->prepare("SELECT * from encabezados;");
			$con->execute();
			$registros = $con->fetchAll(PDO::FETCH_NUM);	
			$n = count($registros);
			$numero = mt_rand(0,($n-1));
			$resultado = $registros[$numero][1];			
			?><h1><?php echo "$resultado" ?></h1><?php
		}
	?>
</body>

</html>
```

# Examen

## Enunciado
- Crear una página web que permita mostrar información que pide el administrador (print, connection, firewall) que se ha insertado previamente en la base de datos, dependiendo de la información que pida el administrador hay que realizar la acción en el sistema operativo.
- La parte de añadir una regla en el firewall se tiene que hacer simulando una conexión en el puerto 2021 por UDP (https://www.jesusninoc.com/02/05/send-time-between-server-and-clients-sockets-udp/)

## Ejemplos de funcionamiento
### - El administrador pide eliminar trabajos de impresión y devuelve un 10, que es el tamaño máximo de fichero que se puede imprimir por lo tanto se borran los mayores de 10 MB
```
http://localhost/P001/default.php?enviar=print
```
### - El administrador pide realizar una conexión por SSH y devuelve una dirección IP
```
http://localhost/P001/default.php?enviar=connection
```
### - El administrador pide crear una regla en el firewall
```
http://localhost/P001/default.php?enviar=firewall
```

## Ayuda para examen
### Ejercicio 1. Leer un valor de una tabla y mostrarlo (1)
* https://github.com/jesusninoc/ClasesIAW/blob/master/2020-02-20.md#ejercicio-1-leer-un-valor-de-una-tabla-y-mostrarlo-1
### Ejercicio 2. Insertar un valor en una tabla, leerlo y mostrarlo (10)
* https://github.com/jesusninoc/ClasesIAW/blob/master/2020-02-20.md#ejercicio-2-insertar-un-valor-en-una-tabla-leerlo-y-mostrarlo-10

## Soluciones
* https://github.com/Kinon4/powershell/blob/master/Examen%20IAW%2024-01.md
* https://github.com/MikeRuSe/Scripts/blob/master/exam.php
* https://github.com/MikeRuSe/Scripts/blob/master/exam.ps1
* https://github.com/Sergio-Armenteros/Prueba-24-01
* https://github.com/DavidCad1412/andel/blob/master/Examen-24-01-20

-----------
-----------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

----------------

# Siempre es mejor programar un plugin o crear un API
* https://www.jesusninoc.com/01/27/importante-fin-del-plugin-para-wordpress-amazon-associates-link-builder-el-9-de-marzo-de-2020/

# Repaso examen
* https://github.com/jesusninoc/ClasesIAW/blob/master/2020-01-24.md#examen

----------------

# PHP
* https://www.php.net/manual/es/langref.php

## El valor NULL
* https://www.php.net/manual/es/language.types.null.php

## Arrays
* https://www.php.net/manual/es/language.types.array.php

## Conversiones de tipos
* https://www.php.net/manual/es/language.types.type-juggling.php

## Variables reservadas
* https://www.php.net/manual/es/reserved.variables.php

### Variable fichero
* https://www.php.net/manual/es/reserved.variables.files.php

## Operadores
* https://www.php.net/manual/es/language.operators.php

## Estructuras condicionales
* https://www.php.net/manual/es/language.control-structures.php

### If
* https://www.php.net/manual/es/control-structures.if.php

# Ejemplos de PHP
## Mostrar el array con todos los elmentos que se han devuelto en la query (print_r)
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
		$base = parse_ini_file("./ini/datos.ini");
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		$con = $php->prepare("SELECT * from encabezados;");
		$con->execute();
		$registros = $con->fetchAll(PDO::FETCH_NUM);
		$php = null;
		
		$n = count($registros);
		print_r($registros);
		$texto = $registros[0][1];
	?>
	<h1><?php echo "$texto"; ?></h1>
</body>

</html>
```

## Mostrar el array con todos los elmentos que se han devuelto en la query
```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
		$base = parse_ini_file("./ini/datos.ini");
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		$con = $php->prepare("SELECT * from encabezados;");
		$con->execute();
		$registros = $con->fetchAll(PDO::FETCH_NUM);
		$php = null;
		
		$n = count($registros);
		// print_r($registros);
		// $texto = $registros[16][1];
		
		for($i=0;$i <= 32;$i++){
			$texto = $registros[$i][1];
			?><h1><?php echo "$texto"; ?></h1>
		<?php } ?>
</body>

</html>
```

# Ejercicios de PHP

## Variables reservadas
```PHP
<!DOCTYPE html>
<html>

<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>P042</title>
</head>

<body>
	<table>
		<?php foreach($_SERVER as $clave => $valor) { ?>
		<tr>
			<td><?php echo "$clave"; ?></td>
			<td><?php echo "$valor"; ?></td>
		</tr>
		<?php } ?>
	</table>
</body>

</html>
```

## Mostrar una tabla con el valor de la variable superglobal $_FILES
### PHP
```PHP
<?php
	$fichero1 = $_POST['fichero1'];
	$fichero2 = $_POST['fichero2'];
	$fichero3 = $_POST['fichero3'];
	$enviar = $_POST['enviar'];
?>
<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>P043</title>
<link type="text/css" rel="stylesheet" href="css/default.css"/>
</head>

<body>
	<div id="pagina">
		<form action="./default.php" method="post" enctype="multipart/form-data">
			<p>
				<input name="fichero1" type="file" size="100" />
			</p>
			<p>
				<input name="fichero2" type="file" size="100" />
			</p>
			<p>
				<input name="fichero3" type="file" size="100" />
			</p>
			<p><input type="submit" name="enviar" value="Enviar"/></p>
		</form>		
		<table>
			<tr>
				<td>fichero</td>
				<td>name</td>
				<td>type</td>
				<td>tmp_name</td>
				<td>error</td>
				<td>size</td>
			</tr>
			<?php foreach($_FILES as $clave => $fichero) { ?>
			<tr>
				<td><?php echo "$clave"; ?></td>
			<?php foreach($fichero as $indice => $valor) { ?>
				<td><?php echo "$valor"; ?></td>
			<?php } ?>
			</tr>
			<?php } ?>
		</table>

	</div>
</body>

</html>
```

### CSS
```CSS
table{
	border-collapse:collapse;}

table td
{
	border:solid 1px red;
	padding:10px;
}
```

## Mostrar usuarios en WordPress
```PHP			
$users = get_users();

foreach ( $users as $user ) {
    echo ' <a href="https://www.jesusninoc.com/user/' . esc_html( $user->display_name )  . '" target="_blank">' . esc_html( $user->display_name )  . '</a>';
}
```

## Generar números aleatorios
```PHP			
<?php

for ($i = 1; $i <= 100; $i++) {
	$numero = mt_rand(676000000,677000000);
	echo $numero . ' ';
}

?>
```

## Enviar un mail cuando alguien accede a una carpeta que no debe
```PHP
<?php
 $ip=$_SERVER['REMOTE_ADDR'];
 $subject="Acceso a secreto";
 $message = "Name: " . $message . "IP of sender: " . $ip;
 mail( "info@example.com", $subject, $message, "From: info@example.com" );
?>
```

## Hacer un login con sesión (GET)
```PHP
<?PHP
session_start();
if($_SERVER["REQUEST_METHOD"] == "GET")
{
    $usuario = "pedro";
    $pass= "123456";
    if(! ($_GET['username'] == $usuario && $_GET['password'] == $pass) )
    {
        Echo "<html>";
        Echo "<title>MUY mal</title>";
        Echo "<b>Acceso denegado</b>";        
        
        session_destroy() ;
        
        return false;
    }
    else {
    
        Echo "<html>";
        Echo "<title>MUY bien</title>";
        Echo "<b>Acceso concedido</b>";
 
        session_destroy();    
 
        return true;
    }
}
?>
```

-----------
-----------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

----------------------

# Ejemplos de PHP

## Enviar información de las variables $_SERVER por mail
```PHP
<?php
$ip=$_SERVER['REMOTE_ADDR'];


$subject="Acceso a secreto sin pulsar";

$message = "Name: " . $message . "ip: " . $ip;

foreach($_SERVER as $clave => $valor) {
	$message = "Name: " . $message . $clave . ": " . $valor . "\n";
}

mail( "JAPON@jesusninoc.com", $subject, $message, "From: JAPON@jesusninoc.com" );
?>
```

## Comprobar si el User Agent es uno en concreto
```PHP
<?php
$usera=$_SERVER['HTTP_USER_AGENT'];

if($usera == "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36")
{
	echo "El User Agent es correcto";
}
	
?>
```

----------------
----------------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

# PHP

## Estructuras de control

### For
* https://www.php.net/manual/es/control-structures.for.php

### Foreach
* https://www.php.net/manual/es/control-structures.foreach.php

## Crear y leer ficheros
* https://www.php.net/manual/es/book.filesystem.php
* https://www.php.net/manual/en/function.file-put-contents.php
* https://www.php.net/manual/es/function.file-get-contents.php
* https://www.jesusninoc.com/07/11/leer-el-contenido-de-una-pagina-web-utilizando-php-desde-powershell/
* https://www.jesusninoc.com/07/13/leer-y-analizar-parsear-el-contenido-de-una-pagina-web-utilizando-php-desde-powershell/

## GET y POST
* https://www.jesusninoc.com/01/02/realizar-peticion-http-utilizando-el-metodo-get/
* https://www.jesusninoc.com/12/09/realizar-peticion-http-utilizando-el-metodo-post/

# Ejemplos de PHP

## Escribir y leer información en un fichero en PHP

```PHP
<?php
	$file = fopen("archivo.txt", "w");
	fwrite($file, "Contenido del fichero" . PHP_EOL);
	fclose($file);

	$file = fopen("archivo.txt", "r");
	
	while(!feof($file)) {
		echo fgets($file). "<br />";
	}

	fclose($file);
?>
```

## Escribir el valor de una variable GET en un fichero y leer la información en PHP
```PHP
<?php

	// php -S localhost:8000
	// http://localhost:8000/?valor=hola
	
	$valor = $_GET["valor"];

	$file = fopen("archivo.txt", "w");
	fwrite($file, $valor . PHP_EOL);
	fclose($file);

	$file = fopen("archivo.txt", "r");
	
	while(!feof($file)) {
		echo fgets($file). "<br />";
	}

	fclose($file);
?>
```

## Escribir el valor de una variable POST en un fichero y leer la información en PHP (examplepost.php)
```PHP
<?php
	$valor = $_POST["valor"];

	$file = fopen("archivo.txt", "w");
	fwrite($file, $valor . PHP_EOL);
	fclose($file);

	$file = fopen("archivo.txt", "r");
	
	while(!feof($file)) {
		echo fgets($file). "<br />";
	}

	fclose($file);
?>
```

### Formulario del POST
```HTML
<form action="examplepost.php" method="post">
    Valor: <input type="text" name="valor" /><br />
    <input type="submit" name="submit" value="Enviar" />
</form>
```

# Ejercicios

## Ejercicio 1. Mostrar un mensaje de forma aleatoria (7)

```PHP
<!DOCTYPE html>
<html>

<head>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<title>P001</title>
</head>

<body>
	<?php
		$base = parse_ini_file("./ini/datos.ini");
		$php = new PDO($base["baseDeDatos"],$base["usuario"],$base["password"]);
		$con = $php->prepare("SELECT * from encabezados;");
		$con->execute();
		$registros = $con->fetchAll(PDO::FETCH_NUM);
		$php = null;
		
		$n = count($registros);
		$numero = mt_rand(0,1);
		$texto = $registros[$numero][1];
	?>
	<h1><?php echo "$texto"; ?></h1>
</body>

</html>
```

## Ejercicio 2. Realizar un login (el usuario y el password hash están almacenador en la base de datos) y los intentos fallidos guardarlos en un log
### Ayuda
#### Si la variable no tiene está definida
```PHP
<?php
	$var = "ljasdf";
	
	$numero1 = isset($var)? $var:NULL;
	
	echo $numero1;
?>
```

#### Hash de un password
```PHP
<?php
	$hola = "hola";
	$hashed = hash("sha512", $hola);
	echo $hashed;
?>
```
### Solución
* https://github.com/Sergio-Armenteros/PHP/blob/master/Login%20con%20sha512

----------------------

# Examen
## - La música se comparte.
* https://github.com/jesusninoc/ClasesISO/blob/master/2019-02-05.md#repaso-de-ficheros-de-configuraci%C3%B3n-en-linux
* https://github.com/jesusninoc/ClasesISO/blob/master/2019-02-05.md#compartir-carpetas-en-linux
* https://github.com/jesusninoc/ClasesISO/blob/master/2019-02-05.md#carpetas-compartidas
## - Crear una página web que permita mostrar información que pide el administrador (print, connection, firewall) que se ha insertado previamente en la base de datos, dependiendo de la información que pida el administrador hay que realizar la acción en el sistema operativo (TODAS LAS PETICIONES SE REALIZAN CON PARÁMETROS HASH).
### Ayuda
- Instalar OpenSSH en Windows https://github.com/Kinon4/powershell/blob/master/Open%20SSH%20Windows%20Powershell.md
### Soluciones
* https://github.com/Kinon4/powershell/blob/master/Examen%20IAW%2031-01.md
* https://github.com/Sergio-Armenteros/Prueba-24-01
* https://github.com/DavidCad1412/andel/tree/master/Examen_31_01

----------------------
----------------------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

# PHP

## XML to JSON
* https://www.jesusninoc.com/02/26/convertir-un-fichero-xml-en-json-desde-php-y-utilizarlo-desde-powershell/
* https://www.jesusninoc.com/03/07/convertir-el-fichero-xml-con-la-lista-de-radares-de-espana-utilizando-php-desde-powershell/

## Incluir ficheros externos
* https://www.php.net/manual/es/function.include.php

## Funciones
* https://www.php.net/manual/es/functions.user-defined.php

## Ejecutar comandos en el sistema opeartivo
* https://www.php.net/manual/es/function.shell-exec.php
* https://www.jesusninoc.com/01/06/ejecutar-un-cmdlet-de-powershell-desde-php/
* https://www.jesusninoc.com/02/19/ejecutar-el-cmdlet-get-nettcpconnection-de-powershell-en-php/
* https://www.jesusninoc.com/02/21/ejecutar-en-php-un-cmdlet-de-powershell-en-base64/


# Ejemplos en PHP

## Ejecutar un comando en Linux y mostrar información en PHP

```PHP
<?php
	$salida = shell_exec('ls -lart');
	echo "<pre>$salida</pre>";
?>
```

## Ejecutar un comando en Linux o Windows en PHP

```PHP
<?php
function execCommand($command, $log) {

    if (substr(php_uname(), 0, 7) == "Windows")
    {
        //windows
        pclose(popen("start /B " . $command . " 1> $log 2>&1", "r"));
    }
    else
    {
        //linux
        shell_exec( $command . " 1> $log 2>&1" );
    }
   
    return false;
}
?>
```

# Ejercicios

## Ejercicio 3. Comparar una cadena hash de PowerShell con una cadena de hash de PHP
### Ayuda
#### Código que llama a PowerShell
* https://www.jesusninoc.com/02/05/ejecutar-un-cmdlet-de-powershell-desde-php-2/
#### Código para crear hash en PowerShell
* https://www.jesusninoc.com/02/05/ejecutar-un-codigo-de-powershell-desde-php-que-da-problemas-con-las-comillas-y-parentesis/
#### Código para crear hash en PowerShell que codifica en Base64
* https://www.jesusninoc.com/02/05/ejecutar-un-codigo-de-powershell-desde-php-que-da-problemas-con-las-comillas-y-parentesis/
#### Código en PHP que ejecuta el código de Powershell codificado en Base64
* https://www.jesusninoc.com/02/05/ejecutar-un-codigo-de-powershell-desde-php-que-da-problemas-con-las-comillas-y-parentesis/

----------------------

# Poner en funcionamiento TensorFlow con Docker

## EJECUTAR UN EJEMPLO DE RECONOCIMIENTO DE IMÁGENES CON TENSORFLOW REALIZANDO UNA CONEXIÓN SSH A UN CONTENEDOR DOCKER DESDE POWERSHELL EN WINDOWS
* https://www.jesusninoc.com/10/22/ejecutar-un-ejemplo-de-reconocimiento-de-imagenes-con-tensorflow-realizando-una-conexion-ssh-a-un-contenedor-docker-desde-powershell-en-windows/
* https://towardsdatascience.com/tensorflow-image-recognition-python-api-e35f7d412a70

----------------------
----------------------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

# PHP

## Funciones
* https://www.php.net/manual/es/functions.user-defined.php

## Cifrado y hash

### CCN-STIC-807 – Criptografía de empleo en el ENS
|Tipo de Algoritmo| Acreditados por el CCN|
|--|--
|Cifrado Simétrico|TDEA (Triple Data Encryption Algorithm)
||AES (Advanced Encryption Standard)
|Algoritmos Asimétricos|DSA (Digital Signature Algorithm)
||ECDSA (Elliptic Curve Digital Signature Algorithm)
||RSA (Criptosistema RSA)
||ECIES (Elliptic Curve Integrated Encryption Scheme)
|Intercambio de Clave|DH o DHKA (Diffie-Hellman Key Agreement)
||MQV (Menezes-Qu-Vanstone Key Agreement)
||ECDH (Elliptic Curve Diffie-Hellman)
||ECMQV (Elliptic Curve Menezes-Qu-Vanstone)
|Funciones resumen (Hash)|SHA-2 (Secure Hash Algorithm)
||HMAC (Hash Message Authentication Code )

### HMAC
En la criptografía, un código de autentificación de mensajes en clave-hash (HMAC) es una construcción específica para calcular un código de autentificación de mensaje (MAC) que implica una función hash criptográfica en combinación con una llave criptográfica secreta. Como cualquier MAC, puede ser utilizado para verificar simultáneamente la integridad de los datos y la autentificación de un mensaje. Cualquier función hash criptográfica, tales como MD5 o SHA-1, puede ser utilizada para el cálculo de un HMAC; el algoritmo MAC resultante se denomina HMAC-MD5 o HMAC-SHA1 en consecuencia. La fuerza criptográfica del HMAC depende de la potencia criptográfica de la función de hash subyacente, el tamaño de su salida de hash y el tamaño y calidad de la llave.

### Generar HMAC-SHA256 con PowerShell
https://www.jesusninoc.com/2018/02/18/generar-hmac-sha256-con-powershell/

### Cifrar y descifrar un mensaje con AES desde PHP
```PHP
<?php
/**
 * simple method to encrypt or decrypt a plain text string
 * initialization vector(IV) has to be the same when encrypting and decrypting
 * 
 * @param string $action: can be 'encrypt' or 'decrypt'
 * @param string $string: string to encrypt or decrypt
 *
 * @return string
 */
function encrypt_decrypt($action, $string) {
    $output = false;

    $encrypt_method = "AES-256-CBC";
    $secret_key = 'This is my secret key';
    $secret_iv = 'This is my secret iv';

    // hash
    $key = hash('sha256', $secret_key);
    
    // iv - encrypt method AES-256-CBC expects 16 bytes - else you will get a warning
    $iv = substr(hash('sha256', $secret_iv), 0, 16);

    if ( $action == 'encrypt' ) {
        $output = openssl_encrypt($string, $encrypt_method, $key, 0, $iv);
        $output = base64_encode($output);
    } else if( $action == 'decrypt' ) {
        $output = openssl_decrypt(base64_decode($string), $encrypt_method, $key, 0, $iv);
    }

    return $output;
}

$plain_txt = "This is my plain text";
echo "Plain Text =" .$plain_txt. "\n";

$encrypted_txt = encrypt_decrypt('encrypt', $plain_txt);
echo "Encrypted Text = " .$encrypted_txt. "\n";

$decrypted_txt = encrypt_decrypt('decrypt', $encrypted_txt);
echo "Decrypted Text =" .$decrypted_txt. "\n";

if ( $plain_txt === $decrypted_txt ) echo "SUCCESS";
else echo "FAILED";

echo "\n";

?>
```

### Cifrar una información con AES (la explicación utiliza una función que ha sido declarada OBSOLETA a partir de PHP 7.1.0. Su uso está totalmente desaconsejado)

```PHP
/* Para encriptar la información $secreta se hace lo siguiente: */
$td = mcrypt_module_open('rijndael-256', '', 'ofb', '');
/* Obtener el vector de inicialización */
$is = mcrypt_enc_get_iv_size($td);
$iv = mcrypt_create_iv($is);

/* Obtener la clave */
$ks = mcrypt_enc_get_key_size($td);
$key = substr(md5('very secret key'), 0, $ks);

/* Las funciones mcrypt_enc_get devuelven el tamaño en bytes del vector de inicialización (IV) y de la clave para un determinado descriptor de cifrado. */
/* Inicializar encriptación */
mcrypt_generic_init($td, $key, $iv);

/* Encriptar datos */
$encriptado = mcrypt_generic($td, $secreta);

/* Terminar encriptacion */
mcrypt_generic_deinit($td);

mcrypt_module_close($td);

//Se almacenan &encriptado y $iv
```` 

### Descifrar una información con AES (la explicación utiliza una función que ha sido declarada OBSOLETA a partir de PHP 7.1.0. Su uso está totalmente desaconsejado)

```PHP
/* Para desencriptar una determinada encriptacion $encriptado con un vector de inicialización $iv y una determinada clave $key se hace lo siguiente: */
$td = mcrypt_module_open('rijndael-256', '', 'ofb', '');
ks = mcrypt_enc_get_key_size($td);
$key = substr(md5('very secret key'), 0, $ks);
$iv = //Se obtiene el vector de inicializacion
$encriptado = //Se obtiene el valor a desencriptar

/* Inicializar desencriptación */
mcrypt_generic_init($td, $key, $iv);

/* Desencriptar datos */
$secreta = mdecrypt_generic($td, $encriptado);

/* Terminar desencriptacion */
mcrypt_generic_deinit($td);

mcrypt_module_close($td);
```

# Ejemplos de PHP

## Función de suma
```PHP
function sumar($a,$b)
{
	$valor1 = (int) $a;
	$valor2 = (int) $b;
	$suma = $valor1 + $valor2;
     return $suma; 
}
$valor = 2;
$resultado = 1 - sumar(5,3*$valor); 
```

### Función que suma cualquier número de enteros sería
```PHP
function sumar() 
{
	$suma = 0;

	for($i=0;$i< func_num_args();$i++)
	{
		$suma += (int) func_get_arg($i);
	}

	return $suma;
}
$valor = sumar(1,2,3,4,5,6);
```

### Función que devuelve un valor
```PHP
function menorMayor($a, $b)
{
	$a = (int) $a;
	$b = (int) $b;

	if($a == $b) $comp = 0;
     else if ($a < $b) $comp = -1;
     else $comp = 1;

	return $comp;
}
```

# Ejercicios

## Ejercicio 4. Incrementar un número mediante GET (17)
```PHP
<?php
	$numero = isset($_GET['numero'])? $_GET["numero"]: 0;
	$incrementar = isset($_GET['incrementar'])? $_GET["incrementar"]: "";
?>

<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>P017</title>
</head>
<body>
	<div id="pagina">
		<?php  $num = (int) $numero + 1; ?>
		<form action="./default.php" method="get">
			<p>
				<label>Número</label>   
				<input type="text" name="numero" value="<?php echo "$num"; ?>" maxlength="5" readonly="readonly" />
			</p>
			<p>
				<input type="submit" name="incrementar" value="Incrementar un entero"/>
			</p>
		</form>
	</div>
</body>
</html>
```

## Ejercicio 5. Concatenar campos (21)
```PHP
<?php
	$numero = isset($_GET['numero'])? $_GET["numero"]: 0;
	$incrementar = isset($_GET['incrementar'])? $_GET["incrementar"]: "";
?>

<!DOCTYPE html>
<html>
<head>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
<title>P017</title>
</head>
<body>
	<div id="pagina">
		<form action="./default.php" method="get">
			<p>
				<label>Número</label>   
				<input type="text" name="numero" value="<?php echo "$num . "1""; ?>" maxlength="5" readonly="readonly" />
			</p>
			<p>
				<input type="submit" name="incrementar" value="Incrementar un entero"/>
			</p>
		</form>
	</div>
</body>
</html>
```

-----------
-----------

# PHP
## Crear un sistema que permita cifrar desde PHP con AES y descrifrar con PowerShell
* https://github.com/jesusninoc/ClasesIAW/blob/master/2020-02-05.md#generar-hmac-sha256-con-powershell

## Ejemplo: convertir en Base64 una cadena en Base64 y desde PowerShell convertir de Base64 a cadena
```PHP
<?php

$codi = base64_encode("hola");
$salida = shell_exec("powershell [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String('aG9sYQ=='))");
echo "<pre>$salida</pre>";

?>
```

-----------
-----------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

# Cifrado y descifrado con PHP
* https://www.jesusninoc.com/02/08/cifrar-y-descifrar-con-aes-desde-php-utilizando-el-modo-de-operacion-de-cifrado-de-bloques-ecb/
* https://www.jesusninoc.com/02/05/ejecutar-un-cmdlet-de-powershell-desde-php-2/
* https://www.jesusninoc.com/02/08/cifrar-y-descifrar-con-aes-desde-powershell/
* https://www.jesusninoc.com/02/08/cifrar-con-aes-desde-powershell/
* https://www.jesusninoc.com/02/08/descifrar-con-aes-desde-powershell/
* http://micmap.org/php-by-example/es/function/openssl_encrypt
* https://www.jesusninoc.com/02/23/aproximacion-al-cifrado-y-descifrado-en-powershell/
* https://www.jesusninoc.com/02/08/cifrar-y-descifrar-con-aes-rijndael-de-256-y-modo-de-operacion-de-unidad-de-cifrado-ecb-desde-powershell/

## Ejemplo: cifrar desde PowerShell y descifrar desde PHP
### Cifrar desde PowerShell
```PowerShell
$unencryptedString = "This is my plain text"

# Cifrar
$bytes = [System.Text.Encoding]::UTF8.GetBytes($unencryptedString)

$aesManaged = New-Object "System.Security.Cryptography.AesManaged"
$aesManaged.Mode = [System.Security.Cryptography.CipherMode]::ECB
$aesManaged.BlockSize = 128
$aesManaged.Key = [System.Text.Encoding]::UTF8.GetBytes('This is my secre')

$encryptor = $aesManaged.CreateEncryptor()
$encryptedData = $encryptor.TransformFinalBlock($bytes, 0, $bytes.Length);

$encrypted = [System.Convert]::ToBase64String($encryptedData)

$web = iwr ("http://localhost:81/fich.php?cifrado="+$encrypted)
$web.content
```

### Descifrar desde PHP
```PHP
<?php

// Sustituir el " " por "+" porque se pierde en la url

$cifrado = str_replace(" ","+",$_GET['cifrado']);
echo $cifrado;

function encrypt_decrypt($action, $string) {
    $output = false;

    $encrypt_method = "AES-128-ECB";
    $key = 'This is my secre';

    if ( $action == 'encrypt' ) {
        $output = openssl_encrypt($string, $encrypt_method, $key);
        $output;
    } else if( $action == 'decrypt' ) {
        $output = openssl_decrypt($string, $encrypt_method, $key);
	$output;
    }

    return $output;
}

$decrypted_txt = encrypt_decrypt('decrypt', $cifrado);
echo "Decrypted Text =" .$decrypted_txt. "\n";

echo "\n";

?>
```

## Ejemplo: añadir un hash a una base de datos
* https://github.com/jesusninoc/ClasesIAW/blob/master/2020-02-20.md#acceso-a-bases-de-datos-desde-lenguajes-de-script-de-servidor

## Ejercicio
- Generar un token en PHP que se pueda mandar desde PowerShell
- Convertir el texto generado en AES a Base64
- Añadir un texto cifrado en una base de datos
### Soluciones
* https://github.com/MikeRuSe/Scripts/blob/master/2020_02_10-token.php

--------------
--------------

# Programación de documentos web utilizando lenguajes de «script» de servidor
- Clasificación.
- Integración con los lenguajes de marcas.
- Sintaxis.
- Herramientas de edición de código.
- Elementos del lenguaje estructurado: tipos de datos, variables, operadores, estructuras de control, subprogramas…
- Elementos de orientación a objeto.
- Comentarios.
- Funciones integradas y de usuario.
- Gestión de errores.
- Mecanismos de introducción de información: formularios. Procesamiento de datos recibidos desde el cliente.
- Métodos de envío de datos desde el cliente al servidor.
- Autenticación de usuarios.
- Control de accesos.
- Sesiones. Mecanismos para mantener el estado entre conexiones.
- Configuración del intérprete.

# PHP

## Clases
* https://www.php.net/manual/es/language.oop5.php
### Introducción al concepto de clases en PowerShell
* https://www.jesusninoc.com/03/07/trabajar-con-clases-en-powershell-5/
